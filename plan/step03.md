# **Step 3: The Reader Interface**

## **3.1 Overview**
This step builds the actual reading experience. We will create a `Reader` component that loads the book data from IndexedDB, initializes the `epub.js` `Rendition`, and handles user interaction (navigation, settings).

## **3.2 Component: `ReaderView`**

*   **Route:** `/read/:bookId`
*   **Layout:**
    *   **Header/Toolbar:** Back button, Table of Contents (TOC) toggle, Settings toggle.
    *   **Viewer Area:** The container for the `iframe` generated by `epub.js`.
    *   **Footer/Progress:** Progress bar, Chapter title, Current page/location.

## **3.3 Logic Flow**

1.  **Load Book Data:**
    *   `useParams` gets `bookId`.
    *   Retrieve `ArrayBuffer` from `db.files.get(bookId)`.
    *   Retrieve metadata (for last CFI) from `db.books.get(bookId)`.

2.  **Initialize `epub.js`:**
    ```typescript
    const book = useRef(ePub());
    const rendition = useRef(null);

    useEffect(() => {
        // ... load data ...
        book.current.open(arrayBuffer);

        const r = book.current.renderTo(viewerRef.current, {
            width: '100%',
            height: '100%',
            flow: 'paginated',
            manager: 'default',
        });
        rendition.current = r;

        const initialCfi = savedMetadata.currentCfi || undefined;
        r.display(initialCfi);

        // Event Listeners
        r.on('relocated', (location) => {
            handleRelocated(location);
        });

        // Cleanup
        return () => {
             if (book.current) book.current.destroy();
        };
    }, [bookId]);
    ```

## **3.4 Navigation & Persistence**

### **Turning Pages**
*   **Next:** `rendition.current.next()`
*   **Prev:** `rendition.current.prev()`
*   **Keyboard Support:** Map ArrowLeft/ArrowRight to prev/next.

### **Progress Tracking (`handleRelocated`)**
*   The `relocated` event provides the current location object.
*   Extract `location.start.cfi` (for saving state).
*   Calculate percentage (needs generated locations).
*   **Debounce** saving the CFI to IndexedDB to avoid excessive writes.
*   Update `useReaderStore` with current chapter title and progress.

### **Generating Locations**
*   `epub.js` needs to "run" through the book to calculate page numbers/locations.
*   Run `book.locations.generate(1000)` in a background effect (non-blocking if possible, but `epub.js` runs this on main thread usually).
*   *Optimization:* Save the generated locations JSON to IndexedDB (`locations` store or part of `books`) so we only do this once per book.

## **3.5 Table of Contents (TOC)**
*   Access `book.navigation` to get the TOC tree.
*   Render a Sidebar/Modal with the list.
*   On click: `rendition.display(href)`.

## **3.6 Styling & Themes**
*   Use `rendition.themes.register` to add "Light", "Dark", "Sepia".
*   Allow user to change font size (`rendition.themes.fontSize('120%')`).

## **3.7 Verification**
*   Open a book from library.
*   Book renders correctly.
*   Pagination works (Next/Prev).
*   Progress bar updates.
*   Reloading the page opens the book at the last read position.
*   TOC navigation works.
