============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.1, pluggy-1.6.0
rootdir: /app
plugins: playwright-0.7.2, base-url-2.1.0
collected 1 item

verification/test_tts_queue.py F                                         [100%]

=================================== FAILURES ===================================
___________________________ test_tts_queue[chromium] ___________________________

page = <Page url='http://localhost:5173/read/3f7b302e-9acc-44a1-bd69-aef5e70f3799'>

    def test_tts_queue(page: Page):
        """
        Verifies that the TTS Queue UI is visible and populated.
        Navigates to a known chapter to ensure text is available.
        """
        print("Resetting app...")
        utils.reset_app(page)

        # Ensure book exists
        print("Ensuring book exists...")
        utils.ensure_library_with_book(page)

        # Click on the first book (Alice in Wonderland)
        print("Opening book...")
        page.get_by_test_id("book-card").click()

        # Wait for reader to load
        print("Waiting for reader...")
        expect(page.get_by_test_id("reader-iframe-container")).to_be_visible(timeout=2000)
        # Give some time for book and TOC to load
        page.wait_for_timeout(2000)

        # --- NEW NAVIGATION STEP ---
        print("Navigating to Chapter I via TOC to ensure text availability...")
        page.get_by_test_id("reader-toc-button").click()

        # Wait for TOC to open
        expect(page.get_by_test_id("reader-toc-sidebar")).to_be_visible(timeout=2000)

        # Click on 'Chapter I' or a known chapter.
        # Using specific TOC item test id if possible or locating by text within TOC sidebar
        # We added data-testid="toc-item-{index}" in ReaderView
        # Assuming Chapter I is at index 1 or so (Cover is 0 usually)
        # But to be safe, we can search by text inside the sidebar locators

        toc_sidebar = page.get_by_test_id("reader-toc-sidebar")
        toc_item = toc_sidebar.get_by_text("Chapter I").first

        if toc_item.count() == 0:
                print("Chapter I not found by text, using toc-item-1...")
                toc_item = page.get_by_test_id("toc-item-1")

        toc_text = toc_item.inner_text()
        print(f"Clicking TOC item: {toc_text}")
        toc_item.click()

        # Wait for TOC to close and page to render
        page.wait_for_timeout(2000) # Give epub.js time to render the new chapter

        # ---------------------------

        # 2. Open TTS Controls
        print("Opening TTS controls...")
        page.get_by_test_id("reader-tts-button").click()

        # Check for popup explicitly
        print("Waiting for TTS popup...")
        try:
            expect(page.get_by_test_id("tts-panel")).to_be_visible(timeout=2000)
        except Exception:
            print("Popup did not appear. Attempting click again...")
            page.get_by_test_id("reader-tts-button").click()
            expect(page.get_by_test_id("tts-panel")).to_be_visible(timeout=2000)

        # 3. Check for Queue
        print("Checking for Queue...")
        page.wait_for_timeout(2000) # Allow queue to populate

        # Check if queue container or no text message is visible
        queue_visible = page.get_by_test_id("tts-queue-container").is_visible()
        no_text_visible = page.get_by_text("No text available").is_visible()

        if not queue_visible and not no_text_visible:
             print("Neither Queue nor No text available found. Dumping page text:")
             print(page.inner_text("body"))
             utils.capture_screenshot(page, "tts_queue_fail_unknown")
             raise Exception("TTS Queue UI not found.")

        if no_text_visible:
            print("FAILURE: 'No text available' shown despite navigating to Chapter I.")
            utils.capture_screenshot(page, "tts_queue_fail_no_text")
            raise Exception("TTS Queue shows 'No text available' on a text-heavy page.")

        if queue_visible:
            print("Queue header found.")
            queue_items = page.locator("[data-testid^='tts-queue-item-']")

            # Wait for at least one item
            try:
                 expect(queue_items.first).to_be_visible(timeout=2000)
            except:
                 print("FAILURE: Queue header found but items not visible.")
                 utils.capture_screenshot(page, "tts_queue_fail_empty")
                 raise Exception("TTS Queue is empty.")

            count = queue_items.count()
            print(f"Found {count} queue items.")
            first_text = queue_items.first.text_content()
            print(f"First item: {first_text}")

        utils.capture_screenshot(page, "tts_queue_verification")

        # Additional check: Close TTS
        print("Closing TTS controls...")
>       page.get_by_test_id("reader-tts-button").click()

verification/test_tts_queue.py:109:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/playwright/sync_api/_generated.py:15543: in click
    self._sync(
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/playwright/_impl/_locator.py:160: in click
    return await self._frame.click(self._selector, strict=True, **params)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/playwright/_impl/_frame.py:549: in click
    await self._channel.send("click", self._timeout, locals_to_params(locals()))
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/playwright/_impl/_connection.py:69: in send
    return await self._connection.wrap_api_call(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <playwright._impl._connection.Connection object at 0x7f01db9a30e0>
cb = <function Channel.send.<locals>.<lambda> at 0x7f01db98f420>
is_internal = False, title = None

    async def wrap_api_call(
        self, cb: Callable[[], Any], is_internal: bool = False, title: str = None
    ) -> Any:
        if self._api_zone.get():
            return await cb()
        task = asyncio.current_task(self._loop)
        st: List[inspect.FrameInfo] = getattr(
            task, "__pw_stack__", None
        ) or inspect.stack(0)

        parsed_st = _extract_stack_trace_information_from_stack(st, is_internal, title)
        self._api_zone.set(parsed_st)
        try:
            return await cb()
        except Exception as error:
>           raise rewrite_error(error, f"{parsed_st['apiName']}: {error}") from None
E           playwright._impl._errors.TimeoutError: Locator.click: Timeout 2000ms exceeded.
E           Call log:
E             - waiting for get_by_test_id("reader-tts-button")
E               - locator resolved to <button type="button" data-state="open" aria-expanded="true" aria-haspopup="dialog" aria-controls="radix-:r9:" aria-label="Open Audio Deck" data-testid="reader-tts-button" class="p-2 rounded-full hover:bg-border text-secondary">…</button>
E             - attempting click action
E               2 × waiting for element to be visible, enabled and stable
E                 - element is visible, enabled and stable
E                 - scrolling into view if needed
E                 - done scrolling
E                 - <h2 id="radix-:ra:" class="text-lg font-semibold text-foreground">Audio Deck</h2> from <div role="dialog" tabindex="-1" id="radix-:r9:" data-state="open" data-testid="tts-panel" aria-labelledby="radix-:ra:" aria-describedby="radix-:rb:" class="fixed z-50 bg-background shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500 inset-y-0 right-0 h-full border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm w-full sm:w-[400px] flex flex-col p-0 ga…>…</div> subtree intercepts pointer events
E               - retrying click action
E               - waiting 20ms
E               2 × waiting for element to be visible, enabled and stable
E                 - element is visible, enabled and stable
E                 - scrolling into view if needed
E                 - done scrolling
E                 - <h2 id="radix-:ra:" class="text-lg font-semibold text-foreground">Audio Deck</h2> from <div role="dialog" tabindex="-1" id="radix-:r9:" data-state="open" data-testid="tts-panel" aria-labelledby="radix-:ra:" aria-describedby="radix-:rb:" class="fixed z-50 bg-background shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500 inset-y-0 right-0 h-full border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm w-full sm:w-[400px] flex flex-col p-0 ga…>…</div> subtree intercepts pointer events
E               - retrying click action
E                 - waiting 100ms
E               4 × waiting for element to be visible, enabled and stable
E                 - element is visible, enabled and stable
E                 - scrolling into view if needed
E                 - done scrolling
E                 - <h2 id="radix-:ra:" class="text-lg font-semibold text-foreground">Audio Deck</h2> from <div role="dialog" tabindex="-1" id="radix-:r9:" data-state="open" data-testid="tts-panel" aria-labelledby="radix-:ra:" aria-describedby="radix-:rb:" class="fixed z-50 bg-background shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500 inset-y-0 right-0 h-full border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm w-full sm:w-[400px] flex flex-col p-0 ga…>…</div> subtree intercepts pointer events
E               - retrying click action
E                 - waiting 500ms

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/playwright/_impl/_connection.py:558: TimeoutError
----------------------------- Captured stdout call -----------------------------
Resetting app...
PAGE LOG: [vite] connecting...
PAGE LOG: [vite] connected.
PAGE LOG: %cDownload the React DevTools for a better development experience: https://reactjs.org/link/react-devtools font-weight:bold
Ensuring book exists...
PAGE LOG: ⚠️ React Router Future Flag Warning: React Router will begin wrapping state updates in `React.startTransition` in v7. You can use the `v7_startTransition` future flag to opt-in early. For more information, see https://reactrouter.com/v6/upgrading/future#v7_starttransition.
PAGE LOG: ⚠️ React Router Future Flag Warning: Relative route resolution within Splat routes is changing in v7. You can use the `v7_relativeSplatPath` future flag to opt-in early. For more information, see https://reactrouter.com/v6/upgrading/future#v7_relativesplatpath.
Opening book...
Waiting for reader...
PAGE LOG: Book indexed for search
Navigating to Chapter I via TOC to ensure text availability...
Clicking TOC item: CHAPTER I. Down the Rabbit-Hole
Opening TTS controls...
PAGE LOG: Warning: Missing `Description` or `aria-describedby={undefined}` for {DialogContent}.
PAGE LOG: Warning: Missing `Description` or `aria-describedby={undefined}` for {DialogContent}.
Waiting for TTS popup...
Checking for Queue...
Queue header found.
Found 221 queue items.
First item: CHAPTER I.
Closing TTS controls...
=========================== short test summary info ============================
FAILED verification/test_tts_queue.py::test_tts_queue[chromium] - playwright....
============================== 1 failed in 11.23s ==============================
